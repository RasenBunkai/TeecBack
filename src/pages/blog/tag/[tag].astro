---
import Layout from "../../../layouts/Layout.astro";
import NavBar from "@components/NavBar.astro";

const allPosts = import.meta.glob("../../posts/*.md");

const slugify = (s: string) =>
  s
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .toLowerCase()
    .trim()
    .replace(/[^a-z0-9\s-]/g, "")
    .replace(/\s+/g, "-")
    .replace(/-+/g, "-");

const resolvedPosts = await Promise.all(
  Object.entries(allPosts).map(async ([key, post]) => {
    const mod = await post();
    const fm = (mod as any).frontmatter;

    const pubDateRaw = fm?.pubDate;
    const pubDateISO =
      typeof pubDateRaw === "string"
        ? pubDateRaw.split("T")[0]
        : pubDateRaw instanceof Date
          ? pubDateRaw.toISOString().split("T")[0]
          : null;

    return {
      slug: key.replace("../../", "/"), // /posts/xxx.md  ->  /posts/xxx.md (luego lo ajustamos abajo)
      title: fm?.title ?? "Sin título",
      description: fm?.description ?? "",
      pubDate: pubDateISO ?? "Fecha desconocida",
      pubDateSortable: pubDateISO ? new Date(pubDateISO).getTime() : 0,
      tags: Array.isArray(fm?.tags) ? fm.tags : [],
    };
  })
);

// Normaliza slug a ruta sin .md
const posts = resolvedPosts
  .map((p) => ({...p, slug: p.slug.replace(".md", "")}))
  .sort((a, b) => b.pubDateSortable - a.pubDateSortable);

// Construye mapas y lista de tags estáticos
const tagPairs: Array<{tag: string; slug: string}> = [];
const slugToTag = new Map<string, string>();

for (const p of posts) {
  for (const raw of p.tags) {
    const tag = String(raw);
    const s = slugify(tag);

    // evita duplicados
    if (!slugToTag.has(s)) {
      slugToTag.set(s, tag);
      tagPairs.push({tag, slug: s});
    }
  }
}

export async function getStaticPaths() {
  const allPosts = import.meta.glob("../../posts/*.md");

  const slugify = (s: string) =>
    s
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .toLowerCase()
      .trim()
      .replace(/[^a-z0-9\s-]/g, "")
      .replace(/\s+/g, "-")
      .replace(/-+/g, "-");

  const resolved = await Promise.all(
    Object.values(allPosts).map(async (post) => {
      const mod = await (post as any)();
      const fm = (mod as any).frontmatter;
      return Array.isArray(fm?.tags) ? fm.tags.map(String) : [];
    })
  );

  const tagSlugs = Array.from(new Set(resolved.flat().map((t) => slugify(t))));

  return tagSlugs.map((tag) => ({params: {tag}}));
}

const tagSlug = Astro.params.tag;
const selectedTag = slugToTag.get(tagSlug) ?? "";

const visiblePosts = selectedTag
  ? posts.filter((p) => p.tags.includes(selectedTag))
  : [];

const toTagHref = (tag: string) => `/blog/tag/${slugify(tag)}`;
---

<Layout
  title={`Blog: ${selectedTag || "Tag"}`}
  description={`Artículos etiquetados con: ${selectedTag || "tag"}.`}>
  <NavBar />

  <div class="min-h-screen p-6">
    <div class="max-w-7xl mx-auto bg-white shadow-md rounded-lg p-6">
      <h2
        class="text-indigo-950 text-2xl font-semibold mb-2 sm:text-2xl md:text-4xl text-center tracking-tighter text-pretty pointer-events-none">
        Blog
      </h2>

      <p
        class="text-gray-600 text-center mb-6 text-lg leading-tight tracking-tighter text-pretty pointer-events-none">
        Filtrando por tag:
        <span class="font-semibold text-indigo-950"> {selectedTag}</span>
      </p>

      <div class="flex justify-center mb-8">
        <a
          href="/blog"
          class="px-3 py-1 rounded-full text-sm font-semibold border transition bg-indigo-900 text-white border-indigo-900">
          Ver todos
        </a>
      </div>

      {
        visiblePosts.length === 0 && (
          <p class="text-center text-gray-600">
            No hay artículos para este tag.
          </p>
        )
      }

      <ul
        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 my-8 px-4">
        {
          visiblePosts.map(({slug, title, description, pubDate, tags}) => (
            <li class="flex flex-col bg-slate-50 rounded-2xl border border-indigo-200 shadow-md hover:shadow-xl hover:scale-105 transition-transform duration-300 p-6">
              <div class="flex-1">
                <h4 class="text-indigo-950 text-2xl font-semibold mb-3 tracking-tighter text-pretty pointer-events-none">
                  {title}
                </h4>

                <p class="text-gray-700 text-base leading-relaxed mb-4 tracking-tighter text-pretty pointer-events-none">
                  {description}
                </p>

                {tags?.length > 0 && (
                  <ul class="flex flex-wrap gap-2 mt-2">
                    {tags.map((t) => (
                      <li>
                        <a
                          href={toTagHref(String(t))}
                          class="inline-block bg-indigo-100 text-indigo-800 text-xs font-semibold px-2 py-1 rounded tracking-tighter text-pretty hover:bg-indigo-200 transition">
                          {t}
                        </a>
                      </li>
                    ))}
                  </ul>
                )}
              </div>

              <div class="mt-6 flex flex-col gap-2">
                <a
                  href={slug}
                  class="inline-flex items-center justify-center gap-2 bg-indigo-900 text-white px-4 py-2 rounded-md font-medium text-sm hover:bg-indigo-950 transition-colors duration-300">
                  Leer artículo
                </a>

                <span class="text-sm text-gray-500 text-center leading-relaxed tracking-tighter text-pretty pointer-events-none">
                  Publicado el {pubDate}
                </span>
              </div>
            </li>
          ))
        }
      </ul>
    </div>
  </div>
</Layout>
